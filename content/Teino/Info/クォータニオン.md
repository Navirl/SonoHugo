---
date: 2024-12-21T15:20:51+09:00
title: "クォータニオン"
tags:
 - Info
---

daily:: [2021-08-07](Daily_Note/2021-08-07.md)
up:: [Programming](../Bar/Program/Programming.md)
up:: [Summareading](Bar/Summareading.md)
source:: [クォータニオン (Quaternion) を総整理！ ～ 三次元物体の回転と姿勢を鮮やかに扱う ～ - Qiita](https://qiita.com/drken/items/0639cf34cce14e8d58a5#2-%E3%82%AF%E3%82%A9%E3%83%BC%E3%82%BF%E3%83%8B%E3%82%AA%E3%83%B3%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9)



## 1. クォータニオンでやりたいこと
クォータニオンでやりたいのは、3D空間における**回転**と、3D物体の**姿勢**を表すこと。姿勢は「どう回転してその向きになったか」で回転と同じく表せる。(姿勢は回転の結果) 

姿勢は方向よりも多くの情報を持つ。方向に大きさは要らないため、自由度(次元と大体同じ)は2。しかし姿勢は航空機でいうロール成分が必要になるので、方向に+1して3になる。

つまり、**姿勢は最小3個のパラメータで表せる。** 回転は姿勢と本質的に同じなので、同様に3個でいい。実際に3個で姿勢や回転を表しているのがオイラー角。

対して、クォータニオンは4個のパラメータを使っている。このままでは自由度が1つ余るので、それを解決する方法として「ノルムが1」という制約がある。

ちなみに、3x3個のパラメータを使う回転行列という表現法もある。これを縛る制約は「正規直行行列である」こと。

### 1-1. クォータニオンとは
三次元空間において、
- 方向ベクトル $(\lambda_x, \lambda_y, \lambda_z)$ を回転軸として
- 角度$\theta$だけ回転する

という「回転」クォータニオンは、**四次元ベクトル$(\lambda_x \sin⁡{\frac{\theta}{2}}, \lambda_y \sin⁡{\frac{\theta}{2}}, \lambda_z \sin⁡{\frac{\theta}{2}}, \cos{\frac{\theta}{2}})$** で表す。

UnityではそれぞれQuaternion.x,y,z,wとして実装している。生成したいなら`Quaternion.AngleAxis(角度, 軸)`で作れる。

### 1-2. クォータニオンによる回転操作
回転は表せたが、これを実際に回転操作として実装するにはどうすればよいだろう。 
仮に回転操作を$q$と置くと、このようなシンプルな式ができる。

| 回転させるもの | 回転結果 | 備考 |
| --- | --- | --- |
| ベクトル $\vec{v}$ | $q \otimes \vec{v} \otimes \bar{q}$ | $\bar{q}$ は $q$ の逆回転 |
| 姿勢クォータニオン $p$ | $q \otimes p$ |  |

クォータニオン同士の掛け算$q \otimes p$、クォータニオンとベクトルの掛け算$q \otimes \vec{v}$の定義は1-4で。**掛け算は不可換、つまり左右の入れ替えは不可能。** 
なお、$\otimes$はテンソル積という代物。あるベクトル空間における新しいベクトル空間を示す。が、ここではめんどいので専用掛け算記号として見ていればいい。 
unityでは`*`で表現する。普段の掛け算と同じ。

[テンソルとは何か Part.1 \| 高校数学の美しい物語](https://manabitimes.jp/math/1845)

### 1-3. クォータニオンを選ぶ理由
| パラメータ数 | メモリ消費 | 計算上の扱いやすさ | 備考 |  |
| --- | --- | --- | --- | --- |
| クォータニオン | 4 | ⚪︎ | ◎ | バランス型で、その他様々なメリットがあります |
| オイラー角 | 3 | ◎ | × | 具体的な姿勢をイメージしやすく、メモリ的にも優しいですが、計算上の難点を抱えています |
| 回転行列 or DCM | 9 | × | ⚪︎ |  |

クォータニオンはメモリ消費、扱いやすさの両面でバランスが取れている。数値誤差も生じにくい。

オイラー角はメモリ消費が少ないが、**三角関数を多用する関係上計算時間が大きい。** また、二番目の角度が+-90度によって起きる問題、**ジンバルロック**が厄介。(ヨーとロールの回転軸がそろい、区別がつかなくなる) 
しかしイメージしやすいので今でもよく見る表現方法。

回転行列は、実はクォータニオンと本質的には同じ。**回転行列の持つ性質を維持しつつ、4個のパラメータに圧縮したのがクォータニオン**といえる。 

## 2. クォータニオンの使い方
### 2-1. クォータニオンの生成
|  | 指定するもの | Unity 関数 | 備考 |
| --- | --- | --- | --- |
| 1 | 回転軸と回転角度 | Quaternion.AngleAxis | クォータニオン本来の定義 |
| 2 | オイラー角 | Quaternion.Euler | 角度を 3 つ指定します |
| 3 | 向けたい方向 | Transform.LookAt | 今の向いてる方向 (デフォルトで上方向) と、向けたい方向を指定します |

